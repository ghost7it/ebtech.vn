@using Entities.Models;
@using Entities.Enums;
@model Profile
@{
    ViewBag.Title = "Phân quyền duyệt hồ sơ";
    Layout = "~/Areas/Management/Views/Shared/_ManagementLayout.cshtml";
    var canDelete = RoleHelper.CheckPermission(ModuleEnum.Profile, ActionEnum.Delete);
    var canUpdate = RoleHelper.CheckPermission(ModuleEnum.Profile, ActionEnum.Update);
    var canUpdate2 = RoleHelper.CheckPermission(ModuleEnum.ProfileApprove, ActionEnum.Update);
    var canApprove = RoleHelper.CheckPermission(ModuleEnum.Profile, ActionEnum.Verify);
    var canApprove2 = RoleHelper.CheckPermission(ModuleEnum.ProfileApprove, ActionEnum.Verify);
}

<div class="page-bar">
    <ul class="page-breadcrumb">
        <li>
            <i class="fa fa-home"></i>
            <a href="@Url.RouteUrl("ManagementHome")">Trang chủ</a>
            <i class="fa fa-angle-right"></i>
        </li>
        <li>
            <a href="@Url.RouteUrl("ProfileIndex")">Danh sách hồ sơ</a>
            <i class="fa fa-angle-right"></i>
        </li>
        <li>
            <a href="javascript:void(0);">Phân quyền duyệt hồ sơ</a>
        </li>
    </ul>
</div>
@*Bắt đầu nội dung tùy chỉnh*@
<div class="row">
    <div class="col-md-12">
        <div class="profile-sidebar" style="width:250px;">
            <div class="portlet light profile-sidebar-portlet">
                <div class="profile-userpic">
                    <img src="@(string.IsNullOrEmpty(Model.ProfilePicture) ? "http://www.placehold.it/200x200/EFEFEF/AAAAAA&text=No+image" :  Model.ProfilePicture)" class="img-responsive" alt="">
                </div>
                <div class="profile-usertitle">
                    <div class="profile-usertitle-name">
                        @Model.Name
                    </div>
                    <div class="profile-usertitle-job">
                        @Model.Email
                    </div>
                </div>
                <div class="profile-userbuttons">
                    @if (Model.Status == 1)
                    {
                        <h2>
                            <span class="label label-primary">
                                <i class="fa fa-clock-o"></i>  Chưa duyệt
                            </span>
                        </h2>
                        if (canApprove || canApprove2)
                        {
                            <a class="btn btn-circle green btn-sm" href="@Url.RouteUrl("ProfileApprove", new { id = Model.Id })"><i class="fa fa-check-square-o"></i> Duyệt ngay</a>
                            <a class="btn btn-circle btn-danger btn-sm" href="@Url.RouteUrl("ProfileUnApprovedMessageModal", new { id = Model.Id, type = 1 })" data-target="#ajaxmodal" data-toggle="modal"><i class="fa fa-ban"></i> Không duyệt</a>
                        }
                    }
                    else if (Model.Status == 2)
                    {
                        <h2>
                            <span class="label label-success">
                                <i class="fa fa-check-square-o"></i> Đã duyệt
                            </span>
                        </h2>
                        if (canApprove || canApprove2)
                        {
                            <a class="btn btn-circle btn-danger btn-sm" href="@Url.RouteUrl("ProfileUnApprovedMessageModal", new { id = Model.Id, type = 2 })" data-target="#ajaxmodal" data-toggle="modal"><i class="fa fa-ban"></i> Hủy duyệt</a>
                        }
                    }
                    else
                    {
                        <h2>
                            <span class="label label-danger">
                                <i class="fa fa-ban"></i> Không được duyệt
                            </span>
                        </h2>
                        <div>Lý do: @Html.Raw(Model.UnApprovedMessage)</div>
                        if (canApprove || canApprove2)
                        {
                            <a class="btn btn-circle green btn-sm" href="@Url.RouteUrl("ProfileApprove", new { id = Model.Id })"><i class="fa fa-check-square-o"></i> Duyệt ngay</a>
                        }
                    }

                </div>
                <div class="profile-usermenu">
                    <ul class="nav">
                        <li>
                            <a href="@Url.RouteUrl("ProfileDetail", new { id = Model.Id })">
                                <i class="icon-home"></i>
                                Chi tiết hồ sơ
                            </a>
                        </li>
                        @if (canUpdate || canUpdate2)
                        {
                            <li>
                                <a href="@Url.RouteUrl("ProfileUpdate", new { id = Model.Id })">
                                    <i class="icon-settings"></i>
                                    Cập nhật hồ sơ
                                </a>
                            </li>
                        }
                        @if (Model.Status == 2 && (canUpdate || canUpdate2))
                        {
                            if (Model.Account != null)
                            {
                                <li class="active">
                                    <a href="javascript:void(0);">
                                        <i class="icon-settings"></i>
                                        Đã tạo tài khoản
                                    </a>
                                </li>
                            }
                            else
                            {
                                <li class="active">
                                    <a href="@Url.RouteUrl("ProfileCreateAccount", new { id = Model.Id })">
                                        <i class="icon-settings"></i>
                                        Tạo tài khoản
                                    </a>
                                </li>
                            }
                            if (Model.Account != null)
                            {
                                <li class="active">
                                    <a href="@Url.RouteUrl("ProfileCommittee", new { id = Model.Id })">
                                        <i class="icon-settings"></i>
                                        Phân quyền duyệt hồ sơ
                                    </a>
                                </li>
                            }
                        }
                        @if (canDelete)
                        {
                            <li>
                                <a href="@Url.RouteUrl("ProfileDelete", new { id = Model.Id })" onclick="return confirm('Bạn có chắc chắn muốn xóa hồ sơ này không?')">
                                    <i class="fa fa-trash-o"></i>
                                    Xóa hồ sơ này
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
        <div class="profile-content">
            <div class="row">
                <div class="col-md-12">
                    <div class="portlet light">
                        <div class="portlet-body form">
                            @using (Html.BeginForm("Committee", "Profile", FormMethod.Post, new { @class = "form-horizontal form-assign" }))
                            {
                                @Html.AntiForgeryToken()
                                @Html.HiddenFor(model => model.Status)
                                <input type="hidden" name="profileId" id="profileId" value="@Model.Id" />
                                <div class="form-body">
                                    <h2 style="margin:0;" class="margin-bottom-30"> Phân quyền duyệt hồ sơ cho hồ sơ - @Model.Name </h2>
                                    <div class="note note-success">
                                        <h3>Phân quyền</h3>
                                        <p>Hồ sơ được phân quyền sẽ được phép duyệt hồ sơ cựu sinh viên khác cùng trường, khóa học, ngành học</p>
                                        <p>Lưu ý: Bạn phải phân quyền cho tài khoản trong chức năng quản lý tài khoản/nhóm quyền.</p>
                                    </div>
                                    <div class="row">
                                        @if (Model.ProfileOrganizations != null && Model.ProfileOrganizations.Any())
                                        {
                                            foreach (var item in Model.ProfileOrganizations.OrderBy(o => o.StartYear))
                                            {
                                                <div class="col-md-6" style="border-bottom:1px solid #e5e5e5; padding-bottom:20px;">
                                                    <div class="form-group">
                                                        <label class="control-label col-md-5">Trường:</label>
                                                        <div class="col-md-7">
                                                            <p class="form-control-static">
                                                                @item.Organization.Name
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="control-label col-md-5">Ngành:</label>
                                                        <div class="col-md-7">
                                                            <p class="form-control-static">
                                                                @(item.Majors != null ? item.Majors.Name : "")
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="control-label col-md-5">Khóa:</label>
                                                        <div class="col-md-7">
                                                            <p class="form-control-static">
                                                                @(item.Course != null ? item.Course.Name : "")
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="control-label col-md-5">Năm nhập học:</label>
                                                        <div class="col-md-7">
                                                            <p class="form-control-static">
                                                                @item.StartYear
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="control-label col-md-5">Năm tốt nghiệp:</label>
                                                        <div class="col-md-7">
                                                            <p class="form-control-static">
                                                                @item.GraduateYear
                                                            </p>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="IsLiaisonCommittee_@item.Id" class="control-label col-md-5" style="padding-top:0;">
                                                            <b>Phân quyền:</b>
                                                        </label>
                                                        <div class="col-md-7">
                                                            <input type="checkbox" name="IsLiaisonCommittee_@item.Id" id="IsLiaisonCommittee_@item.Id" @(item.IsLiaisonCommittee ? "checked='checked'" : "") />
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        }
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <div class="row">
                                        <div class="col-md-offset-3 col-md-9">
                                            <button type="submit" class="btn green">Ghi nhận <i class="fa fa-check"></i></button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles{
    @Styles.Render("~/Content/adminv1/profile")
    <style>
        .form-group {
            margin-bottom: 0;
        }
    </style>
}
@section Scripts {
    <script type="text/javascript" src="~/Editor/ckeditor/ckeditor.js"></script>
    <script type="text/javascript" src="~/Editor/ckfinder/ckfinder.js"></script>
    <script type="text/javascript">
        jQuery(document).ready(function () {
            $('#Password').focus();
            $(document).on('click', '.btn-un-approve', function (e) {
                e.preventDefault();
                AdminVersionOne.blockUI({
                    message: 'Vui lòng đợi!',
                    overlayColor: 'none',
                    cenrerY: true,
                    boxed: true
                });
                for (instance in CKEDITOR.instances) {
                    CKEDITOR.instances[instance].updateElement();
                }
                var URL = '@Url.RouteUrl("ProfileUnApprovedJson")';
                $.ajax({
                    type: 'POST',
                    url: URL,
                    dataType: 'json',
                    data: $('.form-un-approve').serialize(),
                    success: function (result) {
                        if (result.success == true) {
                            showNoty('Đã ghi nhận thành công!', 'success', 'center', 5000);
                        }
                        else {
                            showNoty(result.message, 'error', 'center', 5000);
                        }
                    },
                    error: function (xhr, ajaxOptions, error) {
                        showNoty('Đã xảy ra lỗi khi thực hiện yêu cầu của bạn. Vui lòng kiểm tra và thử lại!', 'error', 'center', 5000);
                    },
                    complete: function (result) {
                        $('.modal-header .close').click();
                        AdminVersionOne.unblockUI();
                        setTimeout("location.reload(true);", 5000);
                    }
                });
            });
            $(document).on('submit', '.form-assign', function (e) {
                AdminVersionOne.blockUI({
                    message: 'Vui lòng đợi!',
                    overlayColor: 'none',
                    cenrerY: true,
                    boxed: true
                });
            });
        });
    </script>
}